# PatchTST 코인 예측 모델 개선 계획

이 문서는 PatchTST 기반 코인 예측 모델을 리팩토링하고 개선하기 위한 단계를 설명합니다.

## 1단계: 데이터 준비 및 데이터셋 리팩토링

-   **1. 목표 변수(y) 생성 로직 수정** `[완료]`
    -   **이유**: 현재 모델은 목표 변수(price_change_rate)만 예측해야 하지만, 모든 피처를 목표로 잘못 설정하고 있습니다. 또한, PatchTST 모델은 연속된 기간을 예측하는데, 현재 코드는 비연속적인 기간(1, 3, 7일)을 잘못 처리하고 있어 모델의 예측 방식과 맞지 않습니다.
    -   **수정 계획**:
        -   `dataset.py`의 `create_sequences` 함수를 수정합니다.
        -   목표 `y_seq`는 `TARGET_COL`('price_change_rate')만 포함하도록 수정합니다.
        -   모델이 `max(PREDICTION_HORIZONS)`인 7일치의 연속된 기간을 예측하도록 변경하고, `create_sequences` 함수가 이 7일치 목표 데이터를 생성하도록 수정합니다.

-   **2. 데이터셋 클래스(`TimeSeriesDataset`) 수정** `[완료]`
    -   **이유**: 현재 코드는 정적 피처인 `coin_id`를 시계열 데이터에 직접 합쳐서 처리하고 있습니다. 이는 Hugging Face 라이브러리의 표준 방식이 아니며, 모델이 정적 피처를 올바르게 활용하지 못하게 만듭니다.
    -   **수정 계획**:
        -   `dataset.py`의 `TimeSeriesDataset`을 수정합니다.
        -   `coin_id`를 데이터에 직접 합치지 않고, `static_categorical_features`라는 별도의 키로 모델에 전달하도록 변경합니다.

## 2단계: 모델 및 학습 파이프라인 조정

-   **3. 모델 구성 업데이트** `[완료]`
    -   **이유**: 1, 2단계에서 데이터 구조가 변경되었으므로, 모델이 새로운 데이터 구조를 이해하도록 설정 변경이 필요합니다.
    -   **수정 계획**:
        -   `model.py`의 `create_patchtst_model` 함수를 수정합니다.
        -   `num_input_channels` (입력 피처 수) 및 `prediction_length` (예측 길이)를 새로운 데이터 구조에 맞게 업데이트합니다.
        -   모델이 `static_categorical_features`를 입력으로 받을 수 있도록 구성을 추가합니다.

-   **4. 마스킹된 손실을 위한 사용자 정의 Trainer 생성** `[완료]`
    -   **이유**: 모델은 7일 전체를 예측하지만, 우리가 실제로 관심 있는 것은 1, 3, 7일차의 예측 정확도입니다. 따라서, 해당 일자의 예측 오차에만 가중치를 두어 학습해야 합니다.
    -   **수정 계획**:
        -   `transformers.Trainer`를 상속하는 사용자 정의 `Trainer` 클래스를 생성합니다.
        -   `compute_loss` 메소드를 오버라이드하여 1, 3, 7일차의 예측에 대해서만 손실을 계산하도록 마스킹 로직을 추가합니다.

-   **5. 학습 스크립트 업데이트** `[완료]`
    -   **이유**: 위에서 변경된 데이터셋, 모델, Trainer를 학습 과정에 실제로 적용해야 합니다.
    -   **수정 계획**:
        -   `train.py`에서 새로운 데이터셋, 모델, 사용자 정의 Trainer를 사용하도록 코드를 수정합니다.
        -   `compute_metrics` 함수 또한, 마스킹 로직을 반영하여 1, 3, 7일차 예측에 대해서만 성능을 측정하도록 업데이트합니다.

## 3단계: 평가 및 버그 수정

-   **6. `test.py`의 Scaler 처리 수정** `[완료]`
    -   **이유**: 현재 평가 코드는 테스트 데이터로 스케일러를 새로 학습시키고 있습니다. 이는 테스트 데이터의 정보가 모델에 유출되는 심각한 오류이며, 모델 성능을 비현실적으로 좋게 평가하게 만듭니다.
    -   **수정 계획**:
        -   `train.py`에서 학습 데이터로 학습된 `StandardScaler`를 파일로 저장합니다.
        -   `test.py`에서는 저장된 스케일러를 불러와 테스트 데이터를 변환하기만 하도록 수정합니다.

-   **7. 최종 코드 검토 및 검증** `[완료]`
    -   **이유**: 모든 변경사항이 서로 잘 동작하는지 확인하고, 코드의 전반적인 품질과 재현성을 보장하기 위함입니다.
    -   **수정 계획**:
        -   모든 코드 변경 사항의 일관성과 정확성을 검토합니다.
        -   코드가 `environment.yml`에 명시된 라이브러리 버전과 호환되는지 최종 확인합니다.
        -   이해하기 어려운 로직에 주석을 추가하여 가독성을 높입니다.
